<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenjispace</title>
    <link rel="stylesheet" href="{{stylesUri}}/main.css">
    <link rel="stylesheet" href="{{stylesUri}}/components.css">
    <script>
        // Create a singleton for VS Code API access
        const vscodeApi = (() => {
            let vscode;
            return () => {
                if (!vscode) {
                    vscode = acquireVsCodeApi();
                }
                return vscode;
            };
        })();
    </script>
</head>
<body>
    <div class="container" id="dashboard-container">
        <header>
            <div class="profile">
                <div class="avatar-upload">
                    <div class="avatar">
                        <img src="{{assetsUri}}/default-avatar.png" alt="User Avatar" id="avatar-preview" />
                    </div>
                    <div class="avatar-edit">
                        <input type="file" id="avatarUpload" accept=".jpg, .jpeg, .png" />
                        <label for="avatarUpload">üì∑</label>
                    </div>
                </div>
                <div>
                    <div class="welcome-message" id="welcome-message">Welcome to Zenjispace</div>
                    <div class="daily-quote">Remember: small moments of mindfulness create great clarity.</div>
                </div>
            </div>
            <div class="settings-trigger">
                <button id="settingsButton" class="icon-button">‚öôÔ∏è</button>
            </div>
        </header>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h3>Cloud Sync</h3>
                        <div class="settings-option">
                            <p>Sync your profile, journal entries, and settings across devices.</p>
                            <div class="button-group">
                                <button id="syncToCloudBtn" class="btn">Sync to Cloud</button>
                                <button id="syncFromCloudBtn" class="btn btn-secondary">Restore from Cloud</button>
                            </div>
                            <div id="syncStatus" class="sync-status">
                                <span>Last synced: Never</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Data Management</h3>
                        <div class="settings-option">
                            <p>Clear all your Zenjispace user data including preferences, journal entries, and usage statistics.</p>
                            <button id="clearDataBtn" class="btn btn-danger">Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ai-assistant-container">
            <div class="ai-assistant-bg"></div>
            <div class="ai-assistant">
                <div class="ai-icon">
                    <img src="{{assetsUri}}/zenji-logo.svg" alt="Zenji AI" class="zenji-logo" />
                </div>
                <div class="ai-message">
                    <div class="ai-greeting">I'm Zenji, your mindful AI companion.</div>
                    <div class="ai-suggestion">How can I assist you today? Try the focus timer or a quick breathing session.</div>
                </div>
            </div>
        </div>

        <div class="main-tabs">
            <div class="main-tab active" data-main-tab="mindfulness">
                <span class="main-tab-icon">üßò</span>Mindfulness
            </div>
            <div class="main-tab" data-main-tab="sounds">
                <span class="main-tab-icon">üéµ</span>Sounds
            </div>
            <div class="main-tab" data-main-tab="journal">
                <span class="main-tab-icon">üìì</span>Journal
            </div>
            <div class="main-tab" data-main-tab="chat">
                <span class="main-tab-icon">üí¨</span>Ask Zenji
            </div>
        </div>
        
        <main>
            <!-- Mindfulness tab -->
            <div id="mindfulness-tab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üßò</div>
                        <h2>Focus Tools</h2>
                    </div>
                    <button id="startFocus" class="btn">Start 25min Focus Session</button>
                    <button id="startBreak" class="btn btn-secondary">Take a 5min Break</button>
                    
                    <div class="breathing-circle">
                        <span>Breathe</span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="focusCount">0</div>
                            <div class="stat-label">Focus Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="focusMinutes">0</div>
                            <div class="stat-label">Minutes Focused</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="breakCount">0</div>
                            <div class="stat-label">Breaks Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="moodAvg">-</div>
                            <div class="stat-label">Mood Average</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sounds tab -->
            <div id="sounds-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üéµ</div>
                        <h2>Ambient Sounds</h2>
                    </div>
                    <p>Play calming background sounds to help you focus and relax while coding.</p>
                    
                    <div class="sounds-container" id="soundsContainer">
                        <!-- Sounds will be dynamically loaded here -->
                    </div>
                    
                    <!-- Hidden audio player element -->
                    <audio id="audioPlayer" loop></audio>
                </div>
            </div>

            <!-- Journal tab -->
            <div id="journal-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìì</div>
                        <h2>Journal & Insights</h2>
                    </div>
                    
                    <div class="tabs">
                        <div class="tab active" data-tab="journal">Journal</div>
                        <div class="tab" data-tab="insights">Weekly Insights</div>
                    </div>
                    
                    <div class="tab-content active" id="journal-content-tab">
                        <div class="journal-prompt">
                            <p>Today's prompt: What went well in your coding today?</p>
                        </div>
                        
                        <textarea id="journalEntry" placeholder="Write your thoughts here..." rows="4"></textarea>
                        <button id="saveJournal" class="btn">Save Entry</button>
                        
                        <h3>Recent Entries</h3>
                        <div class="journal-entries" id="journalEntriesList">
                            <!-- Journal entries will be dynamically added here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="insights-content-tab">
                        <!-- Insights will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Chat tab -->
            <div id="chat-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üí¨</div>
                        <h2>Ask Zenji</h2>
                    </div>
                    <div class="ai-chat">
                        <div id="chatMessages"></div>
                        <div id="typingIndicator" class="typing-indicator" style="display: none;">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Ask anything about mindfulness or wellness..." />
                            <button id="sendChat" class="btn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="{{scriptsUri}}/zenji-core.js"></script>
    <script>
        // Initialize the dashboard with user data
        document.addEventListener('DOMContentLoaded', () => {
            // Use the singleton instead of directly acquiring the API
            const vscode = vscodeApi();
            
            // Simply request user data from extension
            vscode.postMessage({ command: 'getUserData' });
            
            // Listen for messages from the extension
            window.addEventListener('message', event => {
                const message = event.data;
                
                if (message.command === 'userData') {
                    // Update avatar and name if available
                    if (message.avatar) {
                        document.getElementById('avatar-preview').src = message.avatar;
                    }
                    
                    if (message.userName) {
                        document.getElementById('welcome-message').textContent = `Welcome back, ${message.userName}`;
                    }
                    
                    // Initialize journal entries if available
                    if (message.journalEntries) {
                        const state = loadState();
                        state.journalEntries = message.journalEntries;
                        saveState(state);
                    }
                }
            });
        });
        
        // Additional settings modal functionality for sync
        document.addEventListener('DOMContentLoaded', () => {
            const syncToCloudBtn = document.getElementById('syncToCloudBtn');
            const syncFromCloudBtn = document.getElementById('syncFromCloudBtn');
            const syncStatus = document.getElementById('syncStatus');
            
            // Get last sync time from state
            const state = loadState();
            if (state.lastCloudSync) {
                try {
                    const syncDate = new Date(state.lastCloudSync);
                    syncStatus.innerHTML = `<span>Last synced: ${syncDate.toLocaleString()}</span>`;
                } catch (e) {
                    console.error('Error parsing last sync date:', e);
                }
            }
            
            // Handle sync to cloud button
            syncToCloudBtn.addEventListener('click', () => {
                syncToCloudBtn.disabled = true;
                syncToCloudBtn.textContent = 'Syncing...';
                syncStatus.innerHTML = `<span>Syncing... <svg class="sync-loader" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="20" height="20" fill="none" stroke="currentColor" stroke-width="8"><circle cx="50" cy="50" r="40" stroke-opacity="0.3"/><path d="M50 10 a40 40 0 0 1 0 80" stroke-linecap="round"><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="1s" repeatCount="indefinite"/></path></svg></span>`;
                sendMessage('syncToCloud');
            });
            
            // Handle restore from cloud button
            syncFromCloudBtn.addEventListener('click', () => {
                if (confirm('This will replace your current data with data from the cloud. Continue?')) {
                    syncFromCloudBtn.disabled = true;
                    syncFromCloudBtn.textContent = 'Restoring...';
                    sendMessage('syncFromCloud');
                }
            });
            
            // Listen for sync complete message
            window.addEventListener('message', event => {
                const message = event.data;
                
                if (message.command === 'syncComplete') {
                    syncToCloudBtn.disabled = false;
                    syncToCloudBtn.textContent = 'Sync to Cloud';
                    
                    syncFromCloudBtn.disabled = false;
                    syncFromCloudBtn.textContent = 'Restore from Cloud';
                    
                    if (message.success) {
                        const now = new Date();
                        syncStatus.innerHTML = `<span>Last synced: ${now.toLocaleString()}</span>`;
                        
                        // Save the last sync time in local state
                        const state = loadState();
                        state.lastCloudSync = now.toISOString();
                        saveState(state);
                        
                        // Refresh the data on the page
                        sendMessage('getUserData');
                    } else {
                        syncStatus.innerHTML = `<span class="sync-error">Sync failed: ${message.error || 'Unknown error'}</span>`;
                        console.error('Sync failed:', message.error);
                    }
                } else if (message.command === 'syncTimeout') {
                    // Handle sync timeout
                    syncToCloudBtn.disabled = false;
                    syncToCloudBtn.textContent = 'Sync to Cloud';
                    
                    syncFromCloudBtn.disabled = false;
                    syncFromCloudBtn.textContent = 'Restore from Cloud';
                    
                    syncStatus.innerHTML = `<span class="sync-error">Sync timed out. Please try again.</span>`;
                    console.error('Sync timed out');
                }
            });
        });
    </script>
</body>
</html>
